DO $$
DECLARE
    src_table   text := 'costar_txv5_joined';           -- ✅ CHANGE HERE
    out_prefix  text := 'costar_txv5_joined_region';    -- ✅ CHANGE HERE
    r           RECORD;
BEGIN
    FOR r IN 
        EXECUTE format(
            'SELECT DISTINCT region, type
             FROM %I
             WHERE region IS NOT NULL 
               AND type IN (''urban'', ''rural'')',
            src_table
        )
    LOOP
        -- Build dynamic output table name
        -- e.g.  costar_txv5_joined_region3_urban
        --       costar_txv5_joined_region10_rural
        DECLARE
            out_table text := format('%s%s_%s', out_prefix, r.region, r.type);
        BEGIN
            -- Drop existing
            EXECUTE format('DROP TABLE IF EXISTS %I', out_table);

            -- Build filter clause
            IF r.type = 'urban' THEN
                EXECUTE format(
                    'CREATE TABLE %I AS
                     SELECT *
                     FROM %I
                     WHERE region = %L
                       AND type = %L
                       AND (urban_elderly = 16 OR urban_general = 16)',
                    out_table, src_table, r.region, r.type
                );

            ELSIF r.type = 'rural' THEN
                EXECUTE format(
                    'CREATE TABLE %I AS
                     SELECT *
                     FROM %I
                     WHERE region = %L
                       AND type = %L
                       AND (rural_elderly = 16 OR rural_general = 16)',
                    out_table, src_table, r.region, r.type
                );
            END IF;

            RAISE NOTICE 'Created %', out_table;
        END;
    END LOOP;
END $$;
